`åŸå­`æ˜¯CabloyJSæœ€åŸºæœ¬çš„è¦ç´ ï¼Œå¦‚æ–‡ç« ã€å…¬å‘Šã€è¯·å‡å•ï¼Œç­‰ç­‰

é€šè¿‡`åŸå­`çš„ç»„åˆï¼Œå°±å¯ä»¥å®ç°ä»»ä½•æƒ³è¦çš„åŠŸèƒ½ï¼Œå¦‚CMSã€OAã€CRMã€ERPç­‰ç­‰

æ­£ç”±äºä»å„ç§`ä¸šåŠ¡æ¨¡å‹`ä¸­æŠ½è±¡å‡ºæ¥ä¸€ä¸ªé€šç”¨çš„`åŸå­`æ¦‚å¿µï¼Œå› è€Œï¼ŒCabloyJSä¸º`åŸå­`å®ç°äº†è®¸å¤šé€šç”¨çš„ç‰¹æ€§å’ŒåŠŸèƒ½ï¼Œä»è€Œå¯ä»¥ä¾¿åˆ©çš„ä¸ºå„ç±»å®é™…ä¸šåŠ¡èµ‹èƒ½

æ›´è¯¦ç»†çš„`åŸå­`æ¦‚å¿µè¯·å‚è§ï¼š[Cabloyï¼šåŸå­åŸºæœ¬æ¦‚å¿µ](https://cabloy.com/zh-cn/articles/4638e7eef869447bbf2d439007010db7.html)

åœ¨è¿™é‡Œï¼Œä¸»è¦é€šè¿‡åŸå­ç±»å‹`party`ä»‹ç»æœ€åŸºæœ¬çš„æ¦‚å¿µä¸ç”¨æ³•

## ä¸šåŠ¡æ¨¡å—ä¸åŸå­ç±»å‹

å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸šåŠ¡æ¨¡å—æ—¶ï¼Œå°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŸå­ç±»å‹ã€‚æ¯”å¦‚ï¼Œæ¨¡å—`test-party`ä¸­çš„`party`åŸå­ç±»å‹ã€‚ç”±äºæ¨¡å—`test-party`å·²ç»å­˜åœ¨ï¼Œåœ¨è¿™é‡Œä»…æŠŠåˆ›å»ºæ¨¡å—çš„å‘½ä»¤åˆ—å‡ºæ¥ï¼Œå¹¶ä¸éœ€è¦å†æ¬¡æ‰§è¡Œ

``` bash
$ cd /path/to/project
$ npm run cli :create:module test-party -- [--template=module-business] [--suite=test-party]
```

| **åç§°** | **è¯´æ˜** |
|:---|:---|
| moduleName | æ¨¡å—åç§°ï¼Œæ¯”å¦‚`test-party` |
| template | æ¨¡ç‰ˆåç§°ï¼Œæ¯”å¦‚`module-business` |
| suite | å¥—ä»¶åç§°ï¼Œæ¯”å¦‚`test-party`ã€‚`test-partyå¥—ä»¶`åŒ…å«è®¸å¤šæ¨¡å—ï¼Œ`test-partyæ¨¡å—`ä»…ä»…æ˜¯å…¶ä¸­ä¸€ä¸ª |

## å£°æ˜åŸå­ç±»å‹

`åŸå­ç±»å‹`æ˜¯`åŸå­`å¯¹åº”çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¹Ÿæ˜¯åœ¨æ¨¡å—çš„`meta.js`æ–‡ä»¶ä¸­è®¾ç½®

`src/suite-vendor/test-party/modules/test-party/backend/src/meta.js`

``` javascript
const meta = {
  base: {
    atoms: {
      party: {
        info: {
          bean: 'party',
          title: 'Party',
          tableName: 'testParty',
          tableNameModes: {
            default: 'testPartyView',
          },
          language: false,
          category: true,
          tag: true,
        },
        actions: {
        },
        validator: 'party',
        search: {
          validator: 'partySearch',
        },
      },
    },
  },
};
```

| åç§° | è¯´æ˜ |
|----|----|
| info.bean | åŸå­ç±»å‹å¯¹åº”çš„Beanç»„ä»¶åç§° |
| info.title | åŸå­ç±»å‹çš„åç§° |
| info.tableName | åŸå­ç±»å‹å¯¹åº”çš„ä¸šåŠ¡æ•°æ®è¡¨åç§° |
| info.tableNameModes.default | å¯ä»¥æ ¹æ®éœ€è¦æŒ‡å®šæ•°æ®è§†å›¾ |
| info.language | æ˜¯å¦å¯ç”¨`æœ¬åœ°åŒ–` |
| info.category | æ˜¯å¦å¯ç”¨`ç›®å½•` |
| info.tag | æ˜¯å¦å¯ç”¨`æ ‡ç­¾` |
| validator | åŸå­ç±»å‹å¯¹åº”çš„`éªŒè¯å™¨`ï¼Œç”¨äºæ¸²æŸ“ä¸šåŠ¡è¡¨å•ï¼Œå¹¶éªŒè¯è¡¨å•æ•°æ® |
| search.validator | ä¸æœç´¢ç›¸å…³çš„`éªŒè¯å™¨`ï¼Œç”¨äºæ¸²æŸ“è‡ªå®šä¹‰çš„æœç´¢å­—æ®µ |

## åŸå­ä¸šåŠ¡æ•°æ®è¡¨

ä¸æ¨¡å—ç›¸å…³çš„æ•°æ®æ¶æ„å˜æ›´ç®¡ç†ï¼Œéƒ½åœ¨Beanç»„ä»¶`version.manager`ä¸­

`src/suite-vendor/test-party/modules/test-party/backend/src/bean/version.manager.js`

``` javascript
async update(options) {
  if (options.version === 1) {
    // create table: testParty
    let sql = `
      CREATE TABLE testParty (
        id int(11) NOT NULL AUTO_INCREMENT,
        createdAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
        updatedAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        deleted int(11) DEFAULT '0',
        iid int(11) DEFAULT '0',
        atomId int(11) DEFAULT '0',
        personCount int(11) DEFAULT '0',
        partyTypeId int(11) DEFAULT '0',
        PRIMARY KEY (id)
      )
    `;
    await this.ctx.model.query(sql);
  }
}
```

`src/suite-vendor/test-party/modules/test-party/backend/src/beans.js`

``` javascript
const versionManager = require('./bean/version.manager.js');

module.exports = app => {
  const beans = {
    // version
    'version.manager': {
      mode: 'app',
      bean: versionManager,
    },
  };
  return beans;
};
```

## modelå¯¹è±¡

å®šä¹‰ä¸ä¸šåŠ¡æ•°æ®è¡¨å¯¹åº”çš„modelå¯¹è±¡ï¼Œå¯ä»¥æ›´ä¾¿åˆ©çš„æ“ä½œæ•°æ®

`src/suite-vendor/test-party/modules/test-party/backend/src/model/party.js`

``` javascript
module.exports = app => {
  class Party extends app.meta.Model {
    constructor(ctx) {
      super(ctx, { table: 'testParty', options: { disableDeleted: false } });
    }
  }
  return Party;
};
```

| åç§° | é»˜è®¤å€¼ | è¯´æ˜ |
|----|----|----|
| table |    | modelå¯¹è±¡å¯¹åº”çš„æ•°æ®è¡¨å |
| disableDeleted | false | æ˜¯å¦ç¦ç”¨`è½¯åˆ é™¤`ç‰¹æ€§ |

## éªŒè¯å™¨

CabloyJSçš„`éªŒè¯`æœºåˆ¶åº•å±‚é‡‡ç”¨`ajv`ï¼Œå»ºè®®æ‚¨å¯¹[ajv](https://github.com/epoberezkin/ajv)æœ‰åˆæ­¥çš„äº†è§£

ä½¿ç”¨`éªŒè¯å™¨`ï¼Œæˆ‘ä»¬åªéœ€å®šä¹‰å¥½ä¸ä¸šåŠ¡ç›¸å…³çš„`JSON Schema`ï¼Œå°±å¯ä»¥è‡ªåŠ¨æ¸²æŸ“è¡¨å•ï¼ŒåŒæ—¶è¿˜å¯ä»¥è‡ªåŠ¨éªŒè¯è¡¨å•æ•°æ®ï¼Œå¦‚æœè¡¨å•æ•°æ®ä¸ç¬¦åˆé¢„æœŸï¼Œä¼šè‡ªåŠ¨æŠŠé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºå‡ºæ¥

å…³äº`è¡¨å•éªŒè¯`çš„æ›´è¯¦ç»†ä¿¡æ¯è¯·å‚è§ï¼š[CabloyJSï¼šè¡¨å•éªŒè¯](https://cabloy.com/zh-cn/articles/a4438f44288940ce9d47596587ba028b.html)

`src/suite-vendor/test-party/modules/test-party/backend/src/config/validation/schemas.js`

``` javascript
module.exports = app => {
  const schemas = {};
  // party
  schemas.party = {
    type: 'object',
    properties: {
      atomName: {
        type: 'string',
        ebType: 'text',
        ebTitle: 'Party Name',
        notEmpty: true,
      },
      personCount: {
        type: 'number',
        ebType: 'text',
        ebTitle: 'Person Count',
        minimum: 1,
        notEmpty: true,
      },
      partyTypeId: {
        type: 'number',
        ebType: 'select',
        ebTitle: 'Party Type',
        ebOptionsUrl: '/test/party/party/types',
        ebOptionTitleKey: 'name',
        ebOptionValueKey: 'id',
        ebOptionsBlankAuto: true,
        notEmpty: true,
      },
      atomCategoryId: {
        type: 'number',
        ebType: 'category',
        ebTitle: 'Category',
      },
      atomTags: {
        type: [ 'string', 'null' ],
        ebType: 'tags',
        ebTitle: 'Tags',
      },
    },
  };
  // party search
  schemas.partySearch = {
    type: 'object',
    properties: {
      partyTypeId: {
        type: 'number',
        ebType: 'select',
        ebTitle: 'Party Type',
        ebOptionsUrl: '/test/party/party/types',
        ebOptionTitleKey: 'name',
        ebOptionValueKey: 'id',
        ebOptionsBlankAuto: true,
      },
    },
  };
  return schemas;
};
```

## åŸå­Beanä¸åŸå­æŒ‡ä»¤

CabloyJSå°†æ‰€æœ‰ä¸šåŠ¡æ•°æ®çš„æ“ä½œç§°ä¸º`åŸå­æŒ‡ä»¤`ï¼Œä¸»è¦åˆ†ä¸¤ç±»ï¼š

1. `åŸºæœ¬æŒ‡ä»¤`ï¼šcreateã€readã€writeã€delete
2. `æ‰©å±•æŒ‡ä»¤`ï¼šä¸å…·ä½“ä¸šåŠ¡ç›¸å…³çš„æ“ä½œ

åªéœ€ä¸ºåŸå­ç±»å‹æä¾›ä¸€ä¸ªBeanç»„ä»¶ï¼Œå³å¯å°è£…æ‰€æœ‰åŸå­æŒ‡ä»¤çš„ä¸šåŠ¡é€»è¾‘

`src/suite-vendor/test-party/modules/test-party/backend/src/bean/atom.party.js`

``` javascript
module.exports = app => {

  const gPartyTypeEmojis = {
    Birthday: 'ğŸ‚',
    Dance: 'ğŸ’ƒ',
    Garden: 'ğŸ¡',
  };

  class Atom extends app.meta.AtomBase {

    async create({ atomClass, item, user }) {
      // super
      const key = await super.create({ atomClass, item, user });
      // add party
      const res = await this.ctx.model.party.insert({
        atomId: key.atomId,
      });
      return { atomId: key.atomId, itemId: res.insertId };
    }

    async read({ atomClass, options, key, user }) {
      // super
      const item = await super.read({ atomClass, options, key, user });
      if (!item) return null;
      // read
      await this._getMeta(item, options);
      // ok
      return item;
    }

    async select({ atomClass, options, items, user }) {
      // super
      await super.select({ atomClass, options, items, user });
      // select
      for (const item of items) {
        await this._getMeta(item, options);
      }
    }

    async write({ atomClass, target, key, item, options, user }) {
      // super
      await super.write({ atomClass, target, key, item, options, user });
      // update party
      const data = await this.ctx.model.party.prepareData(item);
      data.id = key.itemId;
      await this.ctx.model.party.update(data);
    }

    async delete({ atomClass, key, user }) {
      // delete party
      await this.ctx.model.party.delete({
        id: key.itemId,
      });
      // super
      await super.delete({ atomClass, key, user });
    }

    async _getMeta(item, options) {
      // layout: list/table/mobile/pc
      const layout = options && options.layout;
      // meta
      const meta = this._ensureItemMeta(item);
      // meta.flags
      if (item.partyOver) {
        meta.flags.push(this.ctx.text('PartyOverFlag'));
      }
      if (layout !== 'table' && item.personCount) {
        meta.flags.push(item.personCount + 'P');
      }
      // meta.summary
      if (item.partyTypeCode) {
        const dictItem = await this.ctx.bean.dict.findItem({
          dictKey: 'test-party:dictPartyType',
          code: item.partyTypeCode,
        });
        meta.summary = `${dictItem.options.emoji}${dictItem.titleLocaleFull}`;
      }
    }

  }

  return Atom;
};
```

| åç§° | è¯´æ˜ |
|----|----|
| create | æ–°å»º`party`æ—¶è°ƒç”¨ |
| read | æŸ¥è¯¢å•æ¡`party`æ—¶è°ƒç”¨ |
| select | æŸ¥è¯¢å¤šæ¡`party`æ—¶è°ƒç”¨ |
| write | ä¿®æ”¹`party`æ—¶è°ƒç”¨ |
| delete | åˆ é™¤`party`æ—¶è°ƒç”¨ |

`src/suite-vendor/test-party/modules/test-party/backend/src/beans.js`

``` javascript
const atomParty = require('./bean/atom.party.js');

module.exports = app => {
  const beans = {
    // atom
    'atom.party': {
      mode: 'app',
      bean: atomParty,
    },
  };
  return beans;
};
```