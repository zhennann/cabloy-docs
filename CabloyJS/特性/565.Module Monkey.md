## èƒŒæ™¯è¯´æ˜Ž

ä¸ºäº†å®žçŽ°`å¯¹æ‰©å±•å¼€æ”¾,å¯¹ä¿®æ”¹å…³é—­`çš„å¼€é—­åŽŸåˆ™ï¼ŒCabloyJSä»Žä¸åŒçš„ç»´åº¦æ€è€ƒå¯ä»¥æ‰©å±•çš„æ–¹å¼ã€‚å¯¹äºŽä¸åŒçš„åŠŸèƒ½ï¼ŒCabloyJSé’ˆå¯¹åŠŸèƒ½çš„ç‰¹ç‚¹æä¾›äº†ç›¸åº”çš„æ‰©å±•æœºåˆ¶ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æä¾›äº†`Module Monkey`æœºåˆ¶ï¼Œå¯ä»¥æ·±åº¦æ›¿æ¢æ‰€æœ‰æ¨¡å—çš„å‰ç«¯å’ŒåŽç«¯ç»„ä»¶ï¼Œå®žçŽ°é«˜åº¦çš„å®šåˆ¶å¼€å‘ï¼ˆäºŒæ¬¡å¼€å‘ï¼‰ã€‚`Module Monkey`æœºåˆ¶ä¸€èˆ¬ä¸è½»æ˜“ä½¿ç”¨ï¼Œæ˜¯æœ€åŽçš„å¤§æ‹›

## Module Monkeyæ˜¯ä»€ä¹ˆ

å¯¹äºŽCabloyJSå†…ç½®çš„æ¨¡å—ï¼Œä»¥åŠç¬¬ä¸‰æ–¹æä¾›çš„æ¨¡å—ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³å¯¹è¿™äº›æ¨¡å—æä¾›çš„æŸäº›é¡µé¢ã€åŠŸèƒ½ã€é€»è¾‘è¿›è¡Œæ”¹é€ ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. Forkåˆ†æ”¯ï¼šIf the module provides the source code, we can fork a branch and modify it on this branch
2. Module Monkeyï¼šä½¿ç”¨CabloyJSæä¾›çš„`Module Monkey`æœºåˆ¶ï¼Œä½¿æˆ‘ä»¬å¯ä»¥åƒçŒ´å­ðŸ’ä¸€æ ·ï¼Œå¾ˆè½»æ˜“çš„å¯¹æ¨¡å—çš„æŸäº›ç»„ä»¶è¿›è¡Œæ›¿æ¢

ä¸‹é¢ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¨¡å—`test-partymonkey-monkey`æ¥Monkeyå¦ä¸€ä¸ªæ¨¡å—`test-party`

## åˆ›å»ºModule Monkey

ä¸ºäº†æ¼”ç¤ºçš„éœ€è¦ï¼Œå½“åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼Œä¼šè‡ªåŠ¨åœ¨é¡¹ç›®ä¸­æ·»åŠ æ¨¡å—`test-partymonkey-monkey`ã€‚å¦‚æžœè¦æ–°å»ºä¸€ä¸ªModule Monkeyï¼Œå¯ä»¥å¦‚ä¸‹æ‰€ç¤ºï¼š

``` bash
$ npm init cabloy src/module-vendor/test-partymonkey-monkey --type=module
```

> æ¨¡å—åŽç¼€ï¼š`-monkey`
> - æ¨¡å—å¿…é¡»æ·»åŠ åŽç¼€`-monkey`ï¼Œä»Žè€Œå‘ŠçŸ¥ç³»ç»Ÿè¿™ä¸ªæ¨¡å—æ˜¯ä¸€ä¸ªMonkey

## å‰ç«¯Monkey

é€šè¿‡Monkeyæœºåˆ¶ï¼Œå¯ä»¥æ›¿æ¢å‰ç«¯çš„`é¡µé¢è·¯ç”±`ã€`Vuex Store`ã€`Config`å’Œ`ç»„ä»¶`ï¼Œç­‰ç­‰

### æ³¨å…¥monkey

åœ¨æ¨¡å—å‰ç«¯æ³¨å…¥ä¸€ä¸ªmonkeyå¯¹è±¡

`src/module-vendor/test-partymonkey-monkey/front/src/main.js`

``` javascript
  return cb({
    ...
    monkey: require('./monkey.js').default(Vue),
  });
```

### å®šä¹‰monkey

`src/module-vendor/test-partymonkey-monkey/front/src/monkey.js`

``` javascript
import monkeyerPage from './pages/monkeyer.vue';
import monkeyerComponent from './components/monkeyerComponent.vue';

// eslint-disable-next-line
export default function(Vue) {

  function monkeyRoute(moduleSelf, module, routePath, routeComponent) {
    const route = module.options.routes.find(item => item.path === routePath);
    if (route) {
      route.module = moduleSelf;
      route.component = routeComponent;
    }
  }

  function monkeyStore(moduleSelf, module) {
    const store = module.options.store;
    // monkey getters: message2
    const _message2 = store.getters.message2;
    store.getters.message2 = function(state) {
      const res = _message2(state);
      console.log('monkey-store message2:', res);
      return res;
    };
    // monkey mutations: setMessage
    const _setMessage = store.mutations.setMessage;
    store.mutations.setMessage = function(state, message) {
      _setMessage(state, message);
      console.log('monkey-store setMessage:', state.message);
    };
  }

  function monkeyConfig(moduleSelf, module) {
    const config = module.options.config;
    config.monkeyed = true;
  }

  function monkeyComponent(moduleSelf, module, componentName, component) {
    component.module = moduleSelf;
    module.options.components[componentName] = component;
  }

  return {
    moduleLoaded({ module }) {
      if (module.name !== 'test-party') return;
      const moduleSelf = Vue.prototype.$meta.module.get('test-partymonkey');
      // route
      monkeyRoute(moduleSelf, module, 'kitchen-sink/monkey/monkeyee', monkeyerPage);
      // store
      monkeyStore(moduleSelf, module);
      // config
      monkeyConfig(moduleSelf, module);
      // component
      monkeyComponent(moduleSelf, module, 'monkeyeeComponent', monkeyerComponent);
    },
  };

}
```

## åŽç«¯Monkey

é€šè¿‡Monkeyæœºåˆ¶ï¼Œå¯ä»¥æ›¿æ¢åŽç«¯çš„`APIè·¯ç”±`å’Œ`Config`ï¼Œç­‰ç­‰

### æ³¨å…¥monkey

åœ¨æ¨¡å—åŽç«¯æ³¨å…¥ä¸€ä¸ªmonkeyå¯¹è±¡

`src/module-vendor/test-partymonkey-monkey/backend/src/main.js`

``` javascript
  ...
  // monkey
  const monkey = require('./monkey.js')(app);

  return {
    ...
    monkey,
  };
```

### å®šä¹‰monkey

`src/module-vendor/test-partymonkey-monkey/backend/src/monkey.js`

``` javascript
module.exports = app => {
  // eslint-disable-next-line
  const moduleInfo = app.meta.mockUtil.parseInfoFromPackage(__dirname);

  function monkeyRoute(module, routePath, routeController) {
    const route = module.main.routes.find(item => item.path === routePath);
    if (route) {
      route.controller = routeController;
    }
  }

  function monkeyConfig(module, config) {
    config.monkeyed = true;
  }

  const monkey = {
    moduleLoaded({ module }) {
      if (module.info.relativeName !== 'test-party') return;
      // route
      monkeyRoute(module, 'test/monkey/monkeyee/test', {
        module: moduleInfo.relativeName,
        name: 'monkeyer',
      });
    },
    configLoaded({ module, config }) {
      if (module.info.relativeName !== 'test-party') return;
      // config
      monkeyConfig(module, config);
    },
  };
  return monkey;
};
```
